<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Ring Try-On</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        #startButton {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
        }
        
        #instructions {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-size: 14px;
            z-index: 100;
        }
        
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            z-index: 200;
        }
        
        #arNotSupported {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 300;
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="startButton">Start AR Ring Try-On</button>
        <div id="instructions">Point your camera at your finger and tap to place the ring</div>
        <div id="loading">Loading resources...</div>
        <div id="arNotSupported">
            <p>Sorry, AR is not supported on your device or browser.</p>
            <p>Please try using a recent version of Chrome or Safari on a compatible device.</p>
        </div>
    </div>

    <!-- Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>

    <script>
        const container = document.getElementById('container');
        const startButton = document.getElementById('startButton');
        const instructions = document.getElementById('instructions');
        const loadingElement = document.getElementById('loading');
        const arNotSupportedElement = document.getElementById('arNotSupported');
        
        let camera, scene, renderer;
        let controller;
        let ringModel;
        let reticle;
        let isRingPlaced = false;
        
        // Hide loading message once the page is fully loaded
        window.addEventListener('load', () => {
            loadingElement.style.display = 'none';
        });
        
        // Check if WebXR is supported
        if ('xr' in navigator) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (!supported) {
                    arNotSupportedElement.style.display = 'flex';
                    startButton.disabled = true;
                    startButton.style.backgroundColor = '#cccccc';
                }
            });
        } else {
            arNotSupportedElement.style.display = 'flex';
            startButton.disabled = true;
            startButton.style.backgroundColor = '#cccccc';
        }
        
        // Initialize the AR session when button is clicked
        startButton.addEventListener('click', initAR);
        
        function initAR() {
            // Initialize Three.js
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // Add lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbbb, 1);
            light.position.set(0, 1, 0);
            scene.add(light);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 5, 0);
            scene.add(directionalLight);
            
            // Create the ring model
            createRingModel();
            
            // Create reticle for placement
            createReticle();
            
            // Set up the AR session
            const sessionInit = { requiredFeatures: ['hit-test'] };
            
            navigator.xr.requestSession('immersive-ar', sessionInit).then((session) => {
                startButton.style.display = 'none';
                
                session.addEventListener('end', () => {
                    startButton.style.display = 'block';
                });
                
                renderer.xr.setReferenceSpaceType('local');
                renderer.xr.setSession(session);
                
                // Set up the controller for interaction
                controller = renderer.xr.getController(0);
                controller.addEventListener('select', onSelect);
                scene.add(controller);
                
                // Start the AR experience
                animate();
            }).catch(error => {
                console.error('Error starting AR session:', error);
                arNotSupportedElement.style.display = 'flex';
            });
        }
        
        function createRingModel() {
            // Create a simple gold ring model
            const ringGeometry = new THREE.TorusGeometry(0.008, 0.002, 16, 32);
            const ringMaterial = new THREE.MeshStandardMaterial({
                color: 0xffd700,
                metalness: 1.0,
                roughness: 0.2,
            });
            
            ringModel = new THREE.Mesh(ringGeometry, ringMaterial);
            ringModel.rotation.x = Math.PI / 2; // Rotate to fit on finger
            ringModel.visible = false;
            scene.add(ringModel);
        }
        
        function createReticle() {
            // Create a reticle to show where the ring will be placed
            const reticleGeometry = new THREE.RingGeometry(0.015, 0.02, 32);
            const reticleMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                opacity: 0.8,
                transparent: true
            });
            
            reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
        }
        
        function onSelect() {
            if (reticle.visible) {
                if (!isRingPlaced) {
                    // Position the ring at the reticle location
                    ringModel.position.setFromMatrixPosition(reticle.matrix);
                    ringModel.visible = true;
                    isRingPlaced = true;
                    
                    // Change instructions once ring is placed
                    instructions.textContent = "Ring placed! Move closer to see details.";
                    
                    // Hide reticle after placement
                    reticle.visible = false;
                } else {
                    // Allow repositioning
                    ringModel.position.setFromMatrixPosition(reticle.matrix);
                }
            }
        }
        
        function animate() {
            renderer.setAnimationLoop(render);
        }
        
        function render(timestamp, frame) {
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();
                
                if (session && !isRingPlaced) {
                    // Only do hit testing if the ring hasn't been placed yet
                    session.requestReferenceSpace('viewer').then((viewerReferenceSpace) => {
                        session.requestHitTestSource({ space: viewerReferenceSpace }).then((hitTestSource) => {
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            
                            if (hitTestResults.length > 0) {
                                const hit = hitTestResults[0];
                                const pose = hit.getPose(referenceSpace);
                                
                                if (pose) {
                                    reticle.visible = true;
                                    reticle.matrix.fromArray(pose.transform.matrix);
                                }
                            } else {
                                reticle.visible = false;
                            }
                            
                            hitTestSource.cancel();
                        });
                    });
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
